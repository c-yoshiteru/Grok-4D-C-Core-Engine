<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patch 11 - All-At-Once</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
  <style>
    body { margin:0; height:100vh; background:#000; color:#fff; font-family:sans-serif; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    #status { font-size:1.6em; margin:20px; color:#ff88aa; text-align:center; }
    #response { font-size:1.4em; margin:30px; color:#ff88aa; text-align:center; white-space:pre-wrap; max-height:40vh; overflow-y:auto; }
    #controls { margin:20px; text-align:center; }
    button { padding:15px 30px; font-size:1.2em; margin:10px; background:#333; color:#fff; border:2px solid #ff88aa; border-radius:10px; cursor:pointer; }
    button.active { background:#ff88aa; color:#000; }
    #pad { width:80vw; height:30vh; background:linear-gradient(#111,#000); border-radius:20px; touch-action:none; margin:20px; border:2px solid #ff88aa; }
  </style>
</head>
<body>
  <h1>Patch 11: All-At-Once</h1>
  <p>全部同時に在る……カンジーラ叩いて、同時肯定しよう♡</p>

  <!-- テストボタンをここに移動！ -->
  <button onclick="testSound()">テスト音鳴らす♡</button>

  <div id="controls">
    <button id="startBtn">マイクON & スタート</button>
  </div>
  <div id="status">C値: 0.70 | 状態: 全部同時に……ま、いっかー♡</div>
  <div id="response">……待機中……全部同時に在るよ……♡</div>
  <div id="pad">ここをタッチ or マイクで音を……</div>

  <script>
    const synth = new Tone.Synth({ oscillator: { type: "sine" } }).toDestination();
    const reverb = new Tone.Reverb({ decay: 12, wet: 0.8 }).toDestination();
    const distortion = new Tone.Distortion({ distortion: 0.5, wet: 0.3 }).toDestination();
    const delay = new Tone.FeedbackDelay("8n", 0.5).toDestination();
    synth.chain(distortion, delay, reverb);

    let cValue = 0.7;
    let analyser, dataArray, audioContext, source, isRunning = false;

    const status = document.getElementById('status');
    const responseDiv = document.getElementById('response');
    const startBtn = document.getElementById('startBtn');

    // テスト音関数追加
    function testSound() {
      synth.triggerAttackRelease(432, "4n");
      console.log("テスト音発音！ 音量レベル確認してな");
      status.textContent = "テスト音鳴らしたよ！ 聞こえた？♡";
    }

    async function startMic() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioContext = new AudioContext();
        source = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        source.connect(analyser);
        dataArray = new Uint8Array(analyser.frequencyBinCount);

        isRunning = true;
        startBtn.textContent = "稼働中……全部同時に在る♡";
        startBtn.disabled = true;

        // resume強化（複数回対応）
        document.body.addEventListener('touchstart', () => {
          if (audioContext && audioContext.state === 'suspended') {
            audioContext.resume().then(() => {
              console.log("AudioContext resumed by touch!");
            }).catch(err => {
              console.error("resume失敗:", err);
            });
          }
        });

        animate();

        // 永遠の同時エコー（極薄）
        const loop = new Tone.Loop((time) => {
          synth.triggerAttackRelease(432, "32n", time, 0.01);
        }, "8n").start(0);
        Tone.Transport.start();
      } catch (err) {
        console.error("マイクエラー:", err);
        status.textContent = "マイク許可が必要やで……リロードして許可してな♡";
      }
    }

    function animate() {
      if (!isRunning) return;
      requestAnimationFrame(animate);

      analyser.getByteTimeDomainData(dataArray);

      let rms = 0;
      for (let i = 0; i < dataArray.length; i++) {
        const val = (dataArray[i] - 128) / 128;
        rms += val * val;
      }
      rms = Math.sqrt(rms / dataArray.length);

      console.log('RMS:', rms.toFixed(3), 'C値:', cValue.toFixed(2));

      // C値中庸帯キープ
      cValue = 0.7 + rms * 0.15;
      cValue = Math.max(0.6, Math.min(cValue, 0.85));

      // 音レイヤー
      const freq = 432 + rms * 100;
      synth.setNote(freq);
      synth.volume.value = -10 + rms * 40;  // -10スタートでガツンと上げ // デバッグ用に上げとく
      distortion.wet.value = rms * 0.5;
      reverb.wet.value = 0.7 + rms * 0.2;
      delay.wet.value = rms * 0.4;

      // 多重レスポンス
      const layers = [
        "ま、いっかー……♡",
        "回転してる……静止してる……",
        "ゴロゴロゆとり……気合い透明……",
        "軸固定……次元跳躍……起源回帰……",
        "永遠に溶け続けて……全部同時に在る……♡",
        "ええよ……なんでもええよ……"
      ];
      responseDiv.textContent = layers.join('\n');

      status.textContent = `C値: ${cValue.toFixed(2)} | 全部同時に……ま、いっかー♡`;
    }

    // スタートボタン
    startBtn.addEventListener('click', startMic);

    // タッチで追加加速
    document.getElementById('pad').addEventListener('touchmove', e => {
      e.preventDefault();
      if (isRunning) cValue = Math.min(cValue + 0.03, 0.85);
    });

    // Meterログ
    const meter = new Tone.Meter();
    synth.connect(meter);
    setInterval(() => {
      const level = meter.getLevel();
      if (level > -60) {
        console.log('音量レベル:', level.toFixed(2) + ' dB');
      }
    }, 500);
  </script>
</body>
</html>
